<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Database Schema — fn-uns Docs</title>
<meta name="description" content="All PostgreSQL tables, columns, relationships, and useful queries."/>
<link rel="stylesheet" href="../style.css"/>
<link rel="stylesheet" href="../docs.css"/>
</head>
<body>
<nav>
  <a href="/" class="logo">UNS Framework</a>
  <div class="links">
    <a href="/framework/">Standard v1.0</a><a href="/fn-uns/">fn-uns</a><a href="https://github.com/unsframework" target="_blank">GitHub</a>
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode"><div class="toggle-thumb"><span class="toggle-icon-sun">☀</span><span class="toggle-icon-moon">☾</span></div></button>
  </div>
</nav>
<div class="docs-layout">
  <aside class="docs-sidebar">
    <div class="sidebar-section"><div class="sidebar-title">fn-uns</div><a href="/docs/">Overview</a></div>
    <div class="sidebar-section"><div class="sidebar-title">Introduction</div><a href="/docs/what-is-uns.html">What is the UNS?</a><a href="/docs/why-uns.html">Why UNS Matters</a><a href="/docs/why-faas.html">Why FaaS &amp; GitOps?</a><a href="/docs/architecture.html">Architecture</a></div>
    <div class="sidebar-section"><div class="sidebar-title">Getting Started</div><a href="/docs/getting-started.html">Quick Start</a><a href="/docs/fnkit-basics.html">fnkit Basics</a><a href="/docs/first-deployment.html">First Deployment</a></div>
    <div class="sidebar-section"><div class="sidebar-title">Components</div><a href="/docs/components.html">Overview</a><a href="/docs/uns-sim.html">uns-sim</a><a href="/docs/uns-framework.html">uns-framework</a><a href="/docs/uns-cache.html">uns-cache</a><a href="/docs/uns-log.html">uns-log</a><a href="/docs/uns-state.html">uns-state</a><a href="/docs/uns-stoppage.html">uns-stoppage</a><a href="/docs/uns-productivity.html">uns-productivity</a><a href="/docs/uns-input.html">uns-input</a><a href="/docs/uns-kpi.html">uns-kpi</a></div>
    <div class="sidebar-section"><div class="sidebar-title">Guides</div><a href="/docs/configuration.html">Configuration</a><a href="/docs/manufacturing-kpis.html">Manufacturing KPIs</a><a href="/docs/api-reference.html">API Reference</a></div>
    <div class="sidebar-section"><div class="sidebar-title">Developer</div><a href="/docs/code-patterns.html">Code Patterns</a><a href="/docs/extending.html">Extending</a><a href="/docs/database-schema.html" class="active">Database Schema</a></div>
  </aside>
  <main class="docs-content">
    <h1>Database Schema</h1>
    <p class="page-desc">All PostgreSQL tables, columns, relationships, and useful queries.</p>

    <h2>uns_state</h2>
    <p><strong>Written by:</strong> uns-state — completed machine state durations.</p>
    <table class="def-table"><thead><tr><th>Column</th><th>Type</th><th>Description</th></tr></thead><tbody>
    <tr><td>machine</td><td>TEXT</td><td>Machine identifier</td></tr>
    <tr><td>state</td><td>TEXT</td><td>ACTIVE, IDLE, ALARM, etc.</td></tr>
    <tr><td>started_at / ended_at</td><td>TIMESTAMPTZ</td><td>Duration boundaries</td></tr>
    <tr><td>duration_s</td><td>NUMERIC</td><td>Seconds</td></tr>
    <tr><td>next_state</td><td>TEXT</td><td>Transitioned to</td></tr></tbody></table>
    <h2>uns_stoppage</h2>
    <p><strong>Written by:</strong> uns-stoppage — links 1:1 to uns_state via state_id.</p>
    <table class="def-table"><thead><tr><th>Column</th><th>Type</th><th>Description</th></tr></thead><tbody>
    <tr><td>state_id</td><td>BIGINT UNIQUE</td><td>References uns_state.id</td></tr>
    <tr><td>reason_code</td><td>TEXT</td><td>FAULT, NO_WORK, etc.</td></tr>
    <tr><td>category</td><td>TEXT</td><td>planned / unplanned</td></tr>
    <tr><td>auto_classified</td><td>BOOLEAN</td><td>Auto vs operator override</td></tr></tbody></table>
    <h2>uns_productivity</h2>
    <p><strong>Written by:</strong> uns-productivity — completed production runs.</p>
    <table class="def-table"><thead><tr><th>Column</th><th>Type</th><th>Description</th></tr></thead><tbody>
    <tr><td>program_id / program_name</td><td>TEXT</td><td>CNC program</td></tr>
    <tr><td>parts_completed / parts_target</td><td>INT</td><td>Actual vs target</td></tr>
    <tr><td>parts_per_hour</td><td>NUMERIC</td><td>Throughput rate</td></tr>
    <tr><td>reason</td><td>TEXT</td><td>completed, changed, stopped</td></tr></tbody></table>
    <h2>uns_input</h2>
    <p><strong>Written by:</strong> uns-input — flexible JSONB data.</p>
    <table class="def-table"><thead><tr><th>Column</th><th>Type</th></tr></thead><tbody>
    <tr><td>input_type</td><td>TEXT (scrap, note, quality...)</td></tr>
    <tr><td>operator</td><td>TEXT</td></tr><tr><td>data</td><td>JSONB</td></tr></tbody></table>
    <h2>uns_log</h2>
    <p><strong>Written by:</strong> uns-log — change snapshots.</p>
    <table class="def-table"><thead><tr><th>Column</th><th>Type</th></tr></thead><tbody>
    <tr><td>values</td><td>JSONB (complete snapshot)</td></tr><tr><td>changed</td><td>TEXT[] (changed fields)</td></tr></tbody></table>
    <h2>Useful Queries</h2>
    <div class="yaml-block"><pre style="margin:0;font:inherit;white-space:pre"><span class="yaml-comment">-- Utilisation</span>
SELECT machine, ROUND(SUM(CASE WHEN state='ACTIVE' THEN duration_s ELSE 0 END)/SUM(duration_s)*100,1) AS pct
FROM uns_state WHERE started_at >= NOW()-INTERVAL '24 hours' GROUP BY machine;

<span class="yaml-comment">-- Stoppage pareto</span>
SELECT reason_code, category, COUNT(*), ROUND(SUM(duration_s)/60,1) AS mins
FROM uns_stoppage WHERE started_at >= NOW()-INTERVAL '24 hours'
GROUP BY reason_code, category ORDER BY mins DESC;

<span class="yaml-comment">-- MTBF / MTTR</span>
SELECT machine, ROUND(AVG(duration_s)/60,1) AS mtbf FROM uns_state
WHERE state='ACTIVE' AND next_state='ALARM' GROUP BY machine;
SELECT machine, ROUND(AVG(duration_s)/60,1) AS mttr FROM uns_state
WHERE state='ALARM' GROUP BY machine;</pre></div>

    <div class="docs-nav-buttons">
      <a href="/docs/extending.html" class="docs-nav-btn"><span class="nav-label">Previous</span><span class="nav-title">Extending</span></a>
      <div></div>
    </div>
  </main>
</div>
<script src="../shared.js"></script>
</body>
</html>